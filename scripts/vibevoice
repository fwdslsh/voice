#!/usr/bin/env bash
set -euo pipefail

# Decide if GPU is available (Linux + NVIDIA)
GPU_FLAG=()
if command -v nvidia-smi >/dev/null 2>&1; then
  GPU_FLAG=(--gpus all)
fi

# Pick a host audio player in order of preference
pick_player() {
  for p in ffplay afplay aplay paplay play; do
    if command -v "$p" >/dev/null 2>&1; then
      echo "$p"
      return 0
    fi
  done
  echo ""
  return 1
}

PLAYER="$(pick_player || true)"
if [[ -z "${PLAYER}" ]]; then
  echo "[note] No audio player found on host (ffplay/afplay/aplay/paplay/play). Outputting WAV to stdout."
fi

# shared HF cache speeds up repeated runs
HF_CACHE="${HOME}/.cache/huggingface"
mkdir -p "$HF_CACHE"

# run container and pipe output
if [[ -n "${PLAYER}" ]]; then
  case "$PLAYER" in
    ffplay)
      docker run "${GPU_FLAG[@]}" --rm -i \
        -v "$HF_CACHE":/root/.cache/huggingface \
        vibevoice:local "$@" | \
      ffplay -nodisp -autoexit - >/dev/null 2>&1 || true
      ;;
    afplay)
      # afplay needs a file, so we'll use a temp file
      TMPFILE="$(mktemp --suffix=.wav)"
      cleanup_tmp() { rm -f "$TMPFILE"; }
      trap cleanup_tmp EXIT
      
      docker run "${GPU_FLAG[@]}" --rm -i \
        -v "$HF_CACHE":/root/.cache/huggingface \
        vibevoice:local "$@" > "$TMPFILE"
      afplay "$TMPFILE" || true
      ;;
    aplay|paplay)
      docker run "${GPU_FLAG[@]}" --rm -i \
        -v "$HF_CACHE":/root/.cache/huggingface \
        vibevoice:local "$@" | \
      "$PLAYER" - >/dev/null 2>&1 || true
      ;;
    play)
      docker run "${GPU_FLAG[@]}" --rm -i \
        -v "$HF_CACHE":/root/.cache/huggingface \
        vibevoice:local "$@" | \
      play - >/dev/null 2>&1 || true
      ;;
  esac
else
  # No player found, just output to stdout
  docker run "${GPU_FLAG[@]}" --rm -i \
    -v "$HF_CACHE":/root/.cache/huggingface \
    vibevoice:local "$@"
fi